# Multi-stage Dockerfile for testing LicenseCore++ on different platforms

# Ubuntu 20.04 test environment
FROM ubuntu:20.04 as ubuntu-20-test
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    cmake \
    libssl-dev \
    pkg-config \
    python3 \
    python3-pip \
    valgrind \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .
RUN make clean && make diagnostic && make test_simple
RUN make test_full || echo "OpenSSL test may fail"
CMD ["./tests/integration/real_world_test.sh"]

# Ubuntu 22.04 test environment  
FROM ubuntu:22.04 as ubuntu-22-test
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    cmake \
    libssl-dev \
    pkg-config \
    python3 \
    python3-pip \
    valgrind \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .
RUN make clean && make diagnostic && make test_simple
RUN make test_full || echo "OpenSSL test may fail"
CMD ["./tests/integration/real_world_test.sh"]

# Alpine Linux (minimal) test environment
FROM alpine:latest as alpine-test
RUN apk add --no-cache \
    build-base \
    clang \
    cmake \
    openssl-dev \
    pkgconfig \
    python3 \
    py3-pip

WORKDIR /app
COPY . .
RUN make clean && make diagnostic && make test_simple
RUN make test_full || echo "OpenSSL test may fail"
CMD ["./tests/integration/real_world_test.sh"]

# CentOS/RHEL test environment
FROM centos:8 as centos-test
RUN dnf update -y && dnf install -y \
    gcc-c++ \
    clang \
    cmake \
    openssl-devel \
    pkgconfig \
    python3 \
    python3-pip \
    && dnf clean all

WORKDIR /app
COPY . .
RUN make clean && make diagnostic && make test_simple
RUN make test_full || echo "OpenSSL test may fail"
CMD ["./tests/integration/real_world_test.sh"]

# Final test summary stage
FROM ubuntu:22.04 as test-summary
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    build-essential \
    libssl-dev \
    python3 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .
COPY --from=ubuntu-20-test /app/test_results.txt /tmp/ubuntu-20-results.txt 2>/dev/null || echo "ubuntu-20: not available" > /tmp/ubuntu-20-results.txt
COPY --from=ubuntu-22-test /app/test_results.txt /tmp/ubuntu-22-results.txt 2>/dev/null || echo "ubuntu-22: not available" > /tmp/ubuntu-22-results.txt
COPY --from=alpine-test /app/test_results.txt /tmp/alpine-results.txt 2>/dev/null || echo "alpine: not available" > /tmp/alpine-results.txt
COPY --from=centos-test /app/test_results.txt /tmp/centos-results.txt 2>/dev/null || echo "centos: not available" > /tmp/centos-results.txt

RUN echo "=== Multi-Platform Test Results ===" && \
    echo "Ubuntu 20.04:" && cat /tmp/ubuntu-20-results.txt && \
    echo "Ubuntu 22.04:" && cat /tmp/ubuntu-22-results.txt && \
    echo "Alpine Linux:" && cat /tmp/alpine-results.txt && \
    echo "CentOS 8:" && cat /tmp/centos-results.txt

CMD ["echo", "Multi-platform testing complete. Check logs above."]
