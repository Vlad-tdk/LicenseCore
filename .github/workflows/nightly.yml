name: üåô Nightly Multi-Platform Build

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  nightly-build:
    name: üåô Nightly ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - platform: linux-x64
            os: ubuntu-latest
          - platform: windows-x64
            os: windows-latest
          - platform: macos-universal
            os: macos-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: üî® Build nightly
      run: |
        echo "Building nightly for ${{ matrix.platform }}"
        cd obfuscated
        
        case "${{ matrix.platform }}" in
          linux-x64)
            gcc -std=c99 -Os -DNDEBUG -fvisibility=hidden \
              -DLICENSECORE_OBFUSCATED=1 -DANTI_DEBUG_BUILD \
              -Iinclude -Isrc -c src/license_core_pure_c.c -o src/license_core_pure_c.o
            ar rcs liblicense_core_nightly_linux.a src/license_core_pure_c.o
            ;;
          windows-x64)
            gcc -std=c99 -Os -DNDEBUG -fvisibility=hidden \
              -DLICENSECORE_OBFUSCATED=1 -DANTI_DEBUG_BUILD \
              -Iinclude -Isrc -c src/license_core_pure_c.c -o src/license_core_pure_c.o
            ar rcs liblicense_core_nightly_windows.a src/license_core_pure_c.o
            ;;
          macos-universal)
            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è macOS
            clang -arch x86_64 -std=c99 -Os -DNDEBUG -fvisibility=hidden \
              -DLICENSECORE_OBFUSCATED=1 -DANTI_DEBUG_BUILD \
              -mmacosx-version-min=10.14 -Iinclude -Isrc \
              -c src/license_core_pure_c.c -o src/license_core_pure_c_x64.o
            
            clang -arch arm64 -std=c99 -Os -DNDEBUG -fvisibility=hidden \
              -DLICENSECORE_OBFUSCATED=1 -DANTI_DEBUG_BUILD \
              -mmacosx-version-min=11.0 -Iinclude -Isrc \
              -c src/license_core_pure_c.c -o src/license_core_pure_c_arm64.o
            
            ar rcs liblicense_core_macos_x64.a src/license_core_pure_c_x64.o
            ar rcs liblicense_core_macos_arm64.a src/license_core_pure_c_arm64.o
            
            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É
            lipo -create \
              liblicense_core_macos_x64.a \
              liblicense_core_macos_arm64.a \
              -output liblicense_core_nightly_macos_universal.a
            ;;
        esac

    - name: üì¶ Upload nightly artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nightly-${{ matrix.platform }}
        path: obfuscated/liblicense_core_nightly_*
        retention-days: 7  # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –Ω–µ–¥–µ–ª—é

  nightly-notification:
    name: üìß Nightly Notification
    needs: nightly-build
    runs-on: ubuntu-latest
    if: failure()  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    
    steps:
    - name: üìß Send notification
      run: |
        echo "üö® Nightly build failed!"
        echo "Check the workflow logs for details."
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Slack/Discord/Email
