name: ğŸ”’ LicenseCore++ Multi-Platform Build

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

env:
  BUILD_TYPE: Release
  LIBRARY_NAME: liblicense_core

jobs:
  build:
    name: ğŸ”¨ Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - platform: linux-x64
            os: ubuntu-20.04
            arch: x64
            cc: gcc
            artifact: liblicense_core_linux_x64.a
            
          - platform: linux-arm64
            os: ubuntu-20.04
            arch: arm64
            cc: aarch64-linux-gnu-gcc
            artifact: liblicense_core_linux_arm64.a
            
          # Windows builds
          - platform: windows-x64
            os: windows-2019
            arch: x64
            cc: gcc
            artifact: liblicense_core_windows_x64.a
            
          # macOS builds
          - platform: macos-x64
            os: macos-12  # Intel Mac
            arch: x64
            cc: clang
            artifact: liblicense_core_macos_x64.a
            
          - platform: macos-arm64
            os: macos-14  # Apple Silicon
            arch: arm64
            cc: clang
            artifact: liblicense_core_macos_arm64.a

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup build environment
      run: |
        echo "Setting up build environment for ${{ matrix.platform }}"
        echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV

    # Linux-specific setup
    - name: ğŸ§ Setup Linux cross-compilation
      if: startsWith(matrix.platform, 'linux')
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        if [[ "${{ matrix.platform }}" == "linux-arm64" ]]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu
        fi

    # Windows-specific setup
    - name: ğŸªŸ Setup Windows (MSYS2)
      if: startsWith(matrix.platform, 'windows')
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-make
        update: true

    # macOS-specific setup
    - name: ğŸ Setup macOS
      if: startsWith(matrix.platform, 'macos')
      run: |
        echo "macOS setup complete"
        xcode-select --print-path

    - name: ğŸ”¨ Build library
      run: |
        cd obfuscated
        echo "Building for ${{ matrix.platform }}..."
        
        # Platform-specific build commands
        case "${{ matrix.platform }}" in
          linux-x64)
            gcc -std=c99 -Os -DNDEBUG \
              -fvisibility=hidden \
              -fdata-sections -ffunction-sections \
              -DLICENSECORE_OBFUSCATED=1 \
              -DLICENSECORE_NO_STRINGS=1 \
              -DANTI_DEBUG_BUILD \
              -Iinclude -Isrc \
              -c src/license_core_pure_c.c \
              -o src/license_core_pure_c.o
            ar rcs ${{ matrix.artifact }} src/license_core_pure_c.o
            ;;
            
          linux-arm64)
            aarch64-linux-gnu-gcc -std=c99 -Os -DNDEBUG \
              -fvisibility=hidden \
              -fdata-sections -ffunction-sections \
              -DLICENSECORE_OBFUSCATED=1 \
              -DLICENSECORE_NO_STRINGS=1 \
              -DANTI_DEBUG_BUILD \
              -Iinclude -Isrc \
              -c src/license_core_pure_c.c \
              -o src/license_core_pure_c.o
            aarch64-linux-gnu-ar rcs ${{ matrix.artifact }} src/license_core_pure_c.o
            ;;
            
          windows-x64)
            # Use MSYS2 environment
            export PATH="/mingw64/bin:$PATH"
            gcc -std=c99 -Os -DNDEBUG \
              -fvisibility=hidden \
              -fdata-sections -ffunction-sections \
              -DLICENSECORE_OBFUSCATED=1 \
              -DLICENSECORE_NO_STRINGS=1 \
              -DANTI_DEBUG_BUILD \
              -Iinclude -Isrc \
              -c src/license_core_pure_c.c \
              -o src/license_core_pure_c.o
            ar rcs ${{ matrix.artifact }} src/license_core_pure_c.o
            ;;
            
          macos-x64)
            clang -arch x86_64 -std=c99 -Os -DNDEBUG \
              -fvisibility=hidden \
              -fdata-sections -ffunction-sections \
              -DLICENSECORE_OBFUSCATED=1 \
              -DLICENSECORE_NO_STRINGS=1 \
              -DANTI_DEBUG_BUILD \
              -mmacosx-version-min=10.14 \
              -Iinclude -Isrc \
              -c src/license_core_pure_c.c \
              -o src/license_core_pure_c.o
            ar rcs ${{ matrix.artifact }} src/license_core_pure_c.o
            ;;
            
          macos-arm64)
            clang -arch arm64 -std=c99 -Os -DNDEBUG \
              -fvisibility=hidden \
              -fdata-sections -ffunction-sections \
              -DLICENSECORE_OBFUSCATED=1 \
              -DLICENSECORE_NO_STRINGS=1 \
              -DANTI_DEBUG_BUILD \
              -mmacosx-version-min=11.0 \
              -Iinclude -Isrc \
              -c src/license_core_pure_c.c \
              -o src/license_core_pure_c.o
            ar rcs ${{ matrix.artifact }} src/license_core_pure_c.o
            ;;
        esac

    - name: ğŸ” Verify build
      run: |
        cd obfuscated
        ls -la ${{ matrix.artifact }}
        file ${{ matrix.artifact }} || true
        # Check symbols (platform-specific)
        case "${{ matrix.platform }}" in
          linux-*)
            nm ${{ matrix.artifact }} | grep -E "(lc_|_lc)" | head -10 || true
            ;;
          windows-*)
            # Windows nm equivalent
            objdump -t ${{ matrix.artifact }} | grep -E "(lc_|_lc)" | head -10 || true
            ;;
          macos-*)
            nm ${{ matrix.artifact }} | grep -E "(lc_|_lc)" | head -10 || true
            ;;
        esac

    - name: ğŸ“¦ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-library
        path: obfuscated/${{ matrix.artifact }}
        retention-days: 30

  # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ° Ñ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ğ¼Ğ¸
  create-release:
    name: ğŸ“¦ Create Multi-Platform Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‚ĞµĞ³Ğ¾Ğ² Ğ²ĞµÑ€ÑĞ¸Ğ¹

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: ğŸ—‚ï¸ Organize release files
      run: |
        mkdir -p multiplatform-release/lib
        mkdir -p multiplatform-release/include
        mkdir -p multiplatform-release/docs
        
        # Copy all library files
        find release-artifacts -name "*.a" -exec cp {} multiplatform-release/lib/ \;
        
        # Copy headers
        cp obfuscated/include/license_core_pure_c.h multiplatform-release/include/
        
        # Create documentation
        cat > multiplatform-release/README.md << 'EOF'
        # ğŸ”’ LicenseCore++ Multi-Platform Release
        
        ## ğŸ“¦ Included Libraries:
        
        ### Linux:
        - `liblicense_core_linux_x64.a` - Linux x86_64
        - `liblicense_core_linux_arm64.a` - Linux ARM64
        
        ### Windows:
        - `liblicense_core_windows_x64.a` - Windows x86_64 (MinGW)
        
        ### macOS:
        - `liblicense_core_macos_x64.a` - macOS Intel (x86_64)
        - `liblicense_core_macos_arm64.a` - macOS Apple Silicon (ARM64)
        
        ## ğŸš€ Usage:
        
        ```c
        #include "license_core_pure_c.h"
        
        int main() {
            // Test embedded license
            if (lc_validate_embedded()) {
                printf("âœ… Embedded license valid!\n");
                
                if (lc_has_feature("basic")) {
                    printf("âœ… Basic features available\n");
                }
            }
            
            // Test external license
            const char* license = "{\"user_id\":\"test\",\"features\":[\"basic\",\"premium\"]}";
            if (lc_validate_license(license)) {
                printf("âœ… External license valid!\n");
            }
            
            // Get hardware ID
            printf("ğŸ–¥ï¸ Hardware ID: %s\n", lc_get_hwid());
            
            return 0;
        }
        ```
        
        ## ğŸ”— Linking:
        
        ### Linux:
        ```bash
        gcc app.c -L./lib -llicense_core_linux_x64 -o app
        # or for ARM64:
        gcc app.c -L./lib -llicense_core_linux_arm64 -o app
        ```
        
        ### Windows (MinGW):
        ```bash
        gcc app.c -L./lib -llicense_core_windows_x64 -o app.exe
        ```
        
        ### macOS:
        ```bash
        # Intel Mac:
        gcc app.c -L./lib -llicense_core_macos_x64 -framework IOKit -framework CoreFoundation -o app
        # Apple Silicon:
        gcc app.c -L./lib -llicense_core_macos_arm64 -framework IOKit -framework CoreFoundation -o app
        ```
        
        ## ğŸ”’ Security Features:
        - âœ… Symbol obfuscation
        - âœ… Anti-debug protection
        - âœ… Embedded encrypted license
        - âœ… Minimal symbol export (4 functions only)
        - âœ… Hidden visibility
        - âœ… Debug info stripped
        
        ## ğŸ“Š API Functions:
        - `lc_validate_license(json)` - Validate external license
        - `lc_validate_embedded()` - Validate embedded license
        - `lc_has_feature(name)` - Check feature availability
        - `lc_get_hwid()` - Get hardware ID
        EOF
        
        # Show what we have
        echo "ğŸ“ Release contents:"
        find multiplatform-release -type f -exec ls -la {} \;

    - name: ğŸ“¦ Create release archive
      run: |
        cd multiplatform-release
        tar -czf ../licensecore-multiplatform-${GITHUB_REF#refs/tags/}.tar.gz .
        cd ..
        
        # Create checksums
        sha256sum licensecore-multiplatform-*.tar.gz > checksums.txt

    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          licensecore-multiplatform-*.tar.gz
          checksums.txt
        body: |
          ## ğŸ”’ LicenseCore++ Multi-Platform Release
          
          ### ğŸ“¦ What's included:
          - **Linux**: x86_64, ARM64
          - **Windows**: x86_64 (MinGW)
          - **macOS**: Intel (x86_64), Apple Silicon (ARM64)
          
          ### ğŸ”’ Security Features:
          - Symbol obfuscation and hiding
          - Anti-debug runtime protection
          - Embedded encrypted license
          - Minimal API surface (4 functions)
          
          ### ğŸ“‹ Files:
          - `licensecore-multiplatform-${{ github.ref_name }}.tar.gz` - Complete package
          - `checksums.txt` - SHA256 checksums
          
          Download, extract, and link the appropriate library for your platform!
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ…
  test:
    name: ğŸ§ª Test ${{ matrix.platform }}
    needs: build
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x64
            os: ubuntu-20.04
            artifact: liblicense_core_linux_x64.a
          - platform: windows-x64
            os: windows-2019
            artifact: liblicense_core_windows_x64.a
          - platform: macos-x64
            os: macos-12
            artifact: liblicense_core_macos_x64.a

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Download library artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.platform }}-library
        path: obfuscated/

    - name: ğŸ§ª Build and run test
      run: |
        cd obfuscated
        echo "Testing ${{ matrix.platform }}..."
        
        case "${{ matrix.platform }}" in
          linux-*)
            gcc -std=c99 -DDEBUG_JSON_PARSER -Iinclude -Isrc \
              -o test_${{ matrix.platform }} \
              test/test_obfuscated.c \
              ${{ matrix.artifact }}
            ./test_${{ matrix.platform }}
            ;;
          windows-*)
            gcc -std=c99 -DDEBUG_JSON_PARSER -Iinclude -Isrc \
              -o test_${{ matrix.platform }}.exe \
              test/test_obfuscated.c \
              ${{ matrix.artifact }}
            ./test_${{ matrix.platform }}.exe
            ;;
          macos-*)
            gcc -std=c99 -DDEBUG_JSON_PARSER -Iinclude -Isrc \
              -o test_${{ matrix.platform }} \
              test/test_obfuscated.c \
              ${{ matrix.artifact }} \
              -framework IOKit -framework CoreFoundation -framework Security
            ./test_${{ matrix.platform }}
            ;;
        esac

  # ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  security-analysis:
    name: ğŸ” Security Analysis
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: linux-x64-library
        path: analysis/

    - name: ğŸ” Analyze symbols and security
      run: |
        cd analysis
        echo "ğŸ” Security Analysis Report"
        echo "=========================="
        
        echo "ğŸ“Š File info:"
        file *.a
        ls -la *.a
        
        echo ""
        echo "ğŸ” Exported symbols:"
        nm --defined-only *.a | grep -E " T " | head -20
        
        echo ""
        echo "ğŸ” String analysis:"
        strings *.a | grep -iE "(license|feature|debug|test)" | head -10 || echo "No suspicious strings found"
        
        echo ""
        echo "ğŸ“ Symbol count:"
        SYMBOL_COUNT=$(nm --defined-only *.a | grep -E " T " | wc -l)
        echo "Total exported symbols: $SYMBOL_COUNT"
        
        if [ $SYMBOL_COUNT -le 4 ]; then
          echo "âœ… EXCELLENT: Minimal symbol export"
        elif [ $SYMBOL_COUNT -le 10 ]; then
          echo "âœ… GOOD: Low symbol count"
        else
          echo "âš ï¸ WARNING: High symbol count"
        fi

    - name: ğŸ“Š Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-analysis
        path: analysis/
        retention-days: 30
